# Лекция 4

## Reflection and codegen

## Assembly, метадата, манифест

1) **Assembly** – это минимальная единица развёртывания .NET кода.

    Во время компиляции каждый проект собирается в свою
    Assembly. Любой nuget-пакет – это тоже Assembly, которую
    завернули в дополнительную обёртку.

2) **DLL** можно вскрыть через ildasm или dotPeek и увидеть, что в нём
описываются зависимости, версия, много другой информации
про dll

## Object > MemberInfo > Type

В Type можно найти много информации про данные:

1) Название, namespace, сборка;
2) Является ли структурой, классом, enum’ом, generic’ом;
3) Получить список полей, конструкторов, методов и пр.

## TypeInfo, GetType, typeof

**TypeInfo** в целом позволяет получить около такие же данные с той лишь разницей, что создание **TypeInfo** - это уже процесс парсинга метаданных и получения всей информации, а **Type** предоставляет
методы получения этой информации.

• Самый простые способы получения Type – это метод GetType() у
экземляров и кейворд typeof() для типов.

## TypeBuilder

1) Рассмотрим, как можно создать тип с использованием билдера.
2) TypeBuilder:
3) Имя
4) Атрибуты (класс, структура, интерфейс, вложенный, приватный etc)
5) Базовый тип, реализованные интерфейсы
6) Набор методов Define* (например, DefineConstructor)

## MethodInfo, MethodBuilder

1) MethodInfo (внезапно!) описывает метаинформацию о методах.
2) Например:
3) Название;
4) Атрибуты: приватный, публичный, виртуальный;
5) Типы аргументов и возвращаемого значения.

## Как создать экземпляр

Представим ситуацию, когда мы знаем какой-то тип и нам нужно
создать его экземпляр.

Есть три варианта:

    • where T : new()
    • System.Activator.CreateInstance()
    • FormatterServices.GetUninitializedObject()

# Codegen

## Виды генерации

    • Статик
    • Конвертация
    • CodeDom
    • T4
    • Анализаторы и кодфиксеры
    • Компайл
    • Препоцессинг
    • Во время компиляции
    • Рантайм
    • Работа с метамданными
    • Работа с байтами

**Конвертация между языками**

1) Плюсы: уже всё написано, просто нужно вставить и запустить

2) Минусы: очень сложно, скорее всего нормальной тулы нет или она
не поддерживает почти всё, что есть в языке. Кейсы перевода языка
странные, а выхлоп очень плохой.


**T4**

1) Плюсы: очень наглядно, ещё до запуска неплохо так видно что будет
генерироваться. Минимальный порог вхождения т.к. почти стринг
билдер.

2) Минусы: нужно самому отвечать за валидность сгенерированных
данных, это просто стрингбилдер на максималках. Чтобы узнать о
том, что забыл поставить скобочку в вызове метода, нужно
запустить.

## Атрибуты

**Атрибуты** - это функционал языка, который позволяет расширять
метаинформацию сборки, типа, метода

1) Указание методов, которые являются тестами
2) Указание методов для тестирования
3) Сериализация

**Генерация в помощью Fody**

1) Более реальное применение такого подхода - Fody
2) Система плагинов для расширения языка по средствам генерации
IL
3) Пример использования - атрибут ToString, который генерирует