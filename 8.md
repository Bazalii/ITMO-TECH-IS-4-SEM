# Лекция 8

### Виды выделения:

1) Статическое (во время компиляции знаем сколько нужно памяти)
2) Динамическое (как пойдет)

### Стековая машина:

1) Идея в том, что у нас все на стеке, операции применяются на элементы стека
2) Противопоставляется регистровой машине, которая работает с ячейками
3) VM разных языков бывают как стековыми, таки и регистровыми

### Куча:

1) Одна из осоновных идей, которая заложена в логику работы кучи это указатели
2) Куча не имеет ничего общего со одноименной структурой, данные размещаются произвольно
3) Куча позволяет получить непрерывный участок памяти
4) Освобождение
5) Фрагментация


Сравнение кучи и стека

    Время жизни:
        1) Стек - область видимости переменных
        2) Куча - явное (выдаление и освобождение)

    Область видимости :
        1) Стек - в рамках одного потока
        2) Куча - глобальная, доступ по указателю

    Время доступа:
        1) Стек - быстрый доступ, вероятность кеширования в процессоре
        2) Куча - медленный доступ, есть вероятность уйти в своп

    Выделение: 
        1) Стек - перемещение указателя
        2) Куча - медленно, зависит от ситуации

    Освобождение:
        1) Стек - перемещение указателя
        2) Куча  медленно, зависит от ситуации

    Размер:
        1) Стек - несколько мб 
        2) Куча - ограничен размером диска

### Аллокатор, модификатор, сборщик

Введём три абстракции:

    Модификатор - логика приложения. Чтение, запись, создание.
    Аллокатор - аллоцировать память и деаллоцировать.
    Сбощик - механизм, который осуществаляет сборку мусора


Подсчет ссылок: 

    Идея: давайте хранить объект из ссылки количества её использований,
    будет инкрементить каждый раз, когда запрашивается и декрементить, когда освобождается.

    Плюсы:
    1) Детерминированное освобождение
    2) Не нужна поддержка со стороны среды выполнения

    Проблемы:
    1) Программа должна думать про память
    2) Мёртвый цикл

Обход ссылок

    Идея: начиная от рутов, проходить по всем объектам. Процесс можно разделить на два этапа - пометка и сборка.

    Нужно учитывать, что если мутатор продолжает выполняться во время пометки,
    то граф может измениться.
    Один из способов решить проблему - зафризить весь мутатор.

    Сборку можно разделить на удаление, уплотнение (уплотнение
    копированием, уплотнение на месте)

Обход ссылок

    Плюсы:
    • Не нужно думать про память, она сама разруливается
    • Чистится всё, в том числе циклы
    
    Минусы:
    • Более сложная реализация
    • Недетерменированное освобождение. Происходит "когда-то"
    • Требует остановки выполнения для пометки